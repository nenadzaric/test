/**************************************************************************** 
 * Copyright (C) 2020, Bitmovin, Inc., All Rights Reserved 
 * 
 * This source code and its use and distribution, is subject to the terms 
 * and conditions of the applicable license agreement. 
 * 
 * Bitmovin Player Version 8.34.0 
 * 
 ****************************************************************************/
(function() {
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["subtitles-native"]=e():(t.bitmovin=t.bitmovin||{},t.bitmovin.player=t.bitmovin.player||{},t.bitmovin.player["subtitles-native"]=e())}(this,function(){return webpackJsonpbitmovin_player__name_([29],{255:function(t,e,i){"use strict";var a=this&&this.__assign||function(){return a=Object.assign||function(t){for(var e,i=1,a=arguments.length;i<a;i++){e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},a.apply(this,arguments)};Object.defineProperty(e,"__esModule",{value:!0});var r,n=i(20),s=i(18),o=i(1),l=i(16),u=i(12),d=i(9),c=i(11),h=i(2),v=i(0),b=i(505);!function(t){t.Showing="showing",t.Hidden="hidden",t.Disabled="disabled"}(r||(r={}));var f;!function(t){t.Subtitle="subtitles",t.ForcedSubtitle="forced",t.Caption="captions",t.Metadata="metadata"}(f||(f={}));var T=function(t){var e=80/15,i=2.5,a=t.line-10,r=t.position-10;return a-=a%e,r-=r%i,a=Math.round(a/e),r=Math.round(r/i),{row:a,column:r}},p=function(t){var e=new RegExp("^(?:[a-z]+:)?//","i");return"https:"===location.protocol?t.replace(e,"//"):t},k=function(t){return{id:t.id,lang:t.lang,label:t.label,url:t.url,kind:t.kind,isFragmented:t.isFragmented,enabled:t.textTrack&&t.textTrack.mode!==r.Disabled,forced:t.kind===f.ForcedSubtitle}},g=function(){function t(t,e,i,l){var u=this;if(this.onFileLoaded=function(t,e,i){var a=t.body;a&&u.add(a.trim(),i)},this.onFileLoadError=function(t,e){u.context.logger.debug("Error loading subtitle file: "+JSON.stringify(e)),u.removeSubtitle(u.getSubtitleIDFromUrl(t.url)),u.eventHandler.dispatchEvent(o.PlayerEvent.Warning,new n.PlayerWarning(s.WarningCode.NETWORK_COULD_NOT_LOAD_SUBTITLE)),u.context.logger.debug("Could not load subtitles/captions, got HTTP status code "+t.status)},this.onMetadataCueChangeHandler=function(t){var e=t.currentTarget.activeCues,i={frames:[]};for(var r in e)if(e.hasOwnProperty(r)&&void 0!==e[r].value){var n=e[r].value;d.ArrayHelper.isArrayBuffer(n.data)&&(n=a({},n),n.data=d.ArrayHelper.getArray(new Uint8Array(n.data))),i[n.key]=n.data,i.frames.push(n)}u.eventHandler.dispatchEvent(o.PlayerEvent.Metadata,{metadataType:o.MetadataType.ID3,metadata:i})},this.onCueChange=function(t){var e=t.target;if(e.activeCues&&e.activeCues.length>0){var i=b.TextTrackCueHelper.cueListToArray(e.activeCues),a=u.getIdFromTextTrack(e);b.TextTrackCueHelper.sort(i).forEach(function(t){return u.processCue(a,t)})}},this.addTrack=function(t){var e=window.setTimeout(function(){return u.asyncAddTrack(t)},0);u.timeoutsToClear.push(e)},this.getDefaultLabelForSubtitle=function(){return null},this.setForcedSubtitles=function(){var t;u.activeSubtitleId?u.activeForcedSubtitleId&&u.disableSubtitle(u.activeForcedSubtitleId):(u.activeForcedSubtitleId=null===(t=u.getForcedSubtitleForSelectedLanguage())||void 0===t?void 0:t.id,u.activeForcedSubtitleId&&u.enableSubtitle(u.activeForcedSubtitleId))},this.audioChangeHandler=function(){u.disableSubtitle(u.activeForcedSubtitleId),u.setForcedSubtitles()},this.textTracksChangeHandler=function(){var t=u.getTextTrackAndSubtitleId(),e=t[0],i=t[1];u.activeSubtitleId=i,u.setForcedSubtitles(),i&&e&&e.mode!==r.Hidden&&!u.recentlyAddedTracks.includes(e)&&u.enableSubtitle(i)},this.context=t,this.eventHandler=t.eventHandler,this.video=e,this.type=l,this.metadataTracks=[],this.availableTracks={},this.currentCCIdx=1,this.currentSubIdx=0,this.showNative=!1,this.timeoutsToClear=[],this.recentlyAddedTracks=[],this.activeCues=[],this.subtitleLoader=null,i.hasOwnProperty("style")&&i.style.hasOwnProperty("nativeSubtitles")?this.showNativeAlways=!!i.style.nativeSubtitles:this.showNativeAlways=!1,e.audioTracks&&e.audioTracks.addEventListener("change",this.audioChangeHandler),e.textTracks){for(var c=0;c<e.textTracks.length;c++)this.addTrack({track:e.textTracks[c],isFragmented:!0});"function"==typeof e.textTracks.addEventListener&&(e.textTracks.addEventListener("addtrack",this.addTrack),e.textTracks.addEventListener("change",this.textTracksChangeHandler))}}return t.prototype.getAvailableSubtitles=function(){return Object.values(this.availableTracks||{}).filter(function(t){return t.kind!==f.ForcedSubtitle}).map(k)},t.prototype.enableSubtitle=function(t){var e=this.availableTracks[t];return!e||e.enabled?Promise.resolve(!1):e.textTrack?(this.showNativeAlways||this.showNative?e.textTrack.mode=r.Showing:e.textTrack.mode=r.Hidden,e.enabled=!0,e.loadPromise.then(function(){return!0},function(){return!1})):(e.enabled=!0,Promise.resolve(!0))},t.prototype.disableSubtitle=function(t){var e=this.availableTracks[t];return!(!e||!e.enabled)&&(e.textTrack&&(e.textTrack.mode=r.Disabled),e.enabled=!1,this.activeCues=this.activeCues.filter(function(e){return e.subtitleId!==t}),!0)},t.prototype.toTextTrackCue=function(t){return window.VTTCue?new window.VTTCue(t.start,t.end,t.text):window.TextTrackCue?new TextTrackCue(t.start,t.end,t.text):void 0},t.prototype.getSubtitleIDFromUrl=function(t){if(t&&this.availableTracks)for(var e in this.availableTracks)if(this.availableTracks.hasOwnProperty(e)&&this.availableTracks[e].url===t)return e},t.prototype.add=function(t,e){var i=this.getSubtitleIDFromUrl(e);if(i&&t){for(var r=h.ModuleManager.get(v.ModuleName.Subtitles).SubtitleParserFactory.createInstance(this.context,t),n=r.parse(t),s=0;s<n.length;s++)this.eventHandler.dispatchEvent(o.PlayerEvent.CueParsed,a(a({subtitleId:i},n[s]),{periodId:null})),this.availableTracks[i].textTrack.addCue(this.toTextTrackCue(n[s]));this.eventHandler.dispatchEvent(o.PlayerEvent.SubtitleAdded,{subtitle:k(this.availableTracks[i])})}},t.prototype.loadFile=function(t){var e=this;if(t&&t.trim())return this.context.logger.debug("loading "+t),this.subtitleLoader=new l.DefaultContentLoader(this.context,{maxRetries:this.context.settings.MAX_RETRIES,retryDelay:this.context.settings.RETRY_DELAY,onSuccess:this.onFileLoaded,onFailure:this.onFileLoadError,requestType:u.HttpRequestType.MEDIA_SUBTITLES}),this.subtitleLoader.load(t)["catch"](function(t){e.context.logger.debug("Error while loading subtitles ",t)})},t.prototype.createCueEvents=function(t,e){var i={subtitleId:t,text:e.text,start:e.startTime,end:e.endTime},a=[i];if("subtitles"===e.track.kind)i.text=i.text.replace(/(\r\n|\r|\n)/g,"<br>");else if("captions"===e.track.kind){i.position=T(e);var r=i.text.replace(/<[^>]*>/g,""),n=i.position.column+r.length;n>b.CEA_608_MAX_LINE_LENGTH-1&&(a=b.TextTrackCueHelper.splitCea608Cue(i))}return a},t.prototype.processCue=function(t,e){var i=this;if(e&&!this.showNativeAlways&&!this.showNative){var a=this.createCueEvents(t,e);a.forEach(function(a){var r=i.updateCue(a);r?i.eventHandler.dispatchEvent(o.PlayerEvent.CueUpdate,a):i.activateCue(t,e,a)}),this.removeFloatingCues(t,a)}},t.prototype.removeFloatingCues=function(t,e){var i=this,a=this.activeCues.filter(function(i){var a=e.find(function(t){return i.start===t.start&&i.text===t.text&&i.subtitleId===t.subtitleId});return!a&&i.end===1/0&&i.subtitleId===t});a.length>0&&a.forEach(function(e){i.deactivateCue(t,e)})},t.prototype.updateCue=function(t){var e=this,i=this.activeCues.find(function(i){var a=i.start===t.start,r=i.text===t.text,n=!t.end||i.end===1/0||i.end===e.video.duration||i.end===t.end;return a&&r&&n});return!!i&&(i.end=t.end,!0)},t.prototype.activateCue=function(t,e,i){var a=this;this.activeCues.push(i),e.onexit=function(){var i=a.createCueEvents(t,e);i.forEach(function(e){return a.deactivateCue(t,e)})},this.eventHandler.dispatchEvent(o.PlayerEvent.CueEnter,i)},t.prototype.deactivateCue=function(t,e){var i=this.activeCues.find(function(t){return t.start===e.start&&t.end===e.end&&t.text===e.text});if(i){this.activeCues=this.activeCues.filter(function(t){return t!==i});var a={subtitleId:t,text:i.text,start:i.start,end:i.end};i.position&&(a.position=i.position),this.eventHandler.dispatchEvent(o.PlayerEvent.CueExit,a)}},t.prototype.removeSubtitle=function(t){if(this.availableTracks.hasOwnProperty(t)){this.availableTracks[t].textTrack.mode!==r.Disabled&&this.disableSubtitle(t),this.availableTracks[t].textTrack.mode=r.Disabled;var e=this.availableTracks[t];delete this.availableTracks[t],this.eventHandler.dispatchEvent(o.PlayerEvent.SubtitleRemoved,{subtitle:k(e)})}},t.prototype.signalSourceChange=function(){this.video&&this.video.textTracks&&"function"==typeof this.video.textTracks.addEventListener&&this.video.textTracks.removeEventListener("addtrack",this.addTrack),this.removeAll()},t.prototype.removeAll=function(){this.context.logger.debug("removing all subtitle tracks"),this.timeoutsToClear.forEach(function(t){return clearTimeout(t)}),this.timeoutsToClear=[];for(var t in this.availableTracks)this.availableTracks.hasOwnProperty(t)&&(this.availableTracks[t].textTrack.mode=r.Disabled,this.availableTracks[t].textTrack.removeEventListener("cuechange",this.onCueChange));this.availableTracks={},this.activeCues=[],this.currentCCIdx=1,this.currentSubIdx=0},t.prototype.addSubtitle=function(t){if("function"!=typeof this.video.addTextTrack)return void this.context.logger.warn("adding subtitles not supported!");this.availableTracks.hasOwnProperty(t.id)&&(this.context.logger.debug("re-adding subtitle "+t.id),this.removeSubtitle(t.id));var e=t.url?c.URLHelper.toFullUrl(p(t.url.trim())):null,i={id:t.id,url:e,kind:t.kind,lang:t.lang,label:t.label,textTrack:null,isFragmented:!1,isExternal:!0,loadPromise:null};return this.availableTracks[t.id]=i,this.availableTracks[t.id].textTrack=this.video.addTextTrack(t.kind,t.label),this.availableTracks[t.id].textTrack.mode=r.Disabled,this.availableTracks[t.id].textTrack.addEventListener("cuechange",this.onCueChange),this.loadSubtitleFile(i)},t.prototype.loadSubtitleFile=function(t){var e=this;return t.url?t.loadPromise=this.loadFile(t.url).then(function(){if(!e.getAvailableSubtitles().find(function(e){return e.id===t.id}))throw"subtitle adding failed"}):(this.context.logger.log("No url was provided for an external subtitle, nothing will be loaded."),t.loadPromise=Promise.resolve(),this.eventHandler.dispatchEvent(o.PlayerEvent.SubtitleAdded,{subtitle:t})),t.loadPromise},t.prototype.asyncAddTrack=function(t){for(var e,i,a=this,n=t.track,s=t.isFragmented&&n.kind===f.Subtitle||!1,l=0,u=Object.keys(this.availableTracks);l<u.length;l++){var d=u[l],c=this.availableTracks[d];if(c.textTrack===n&&c.isExternal)return void this.context.logger.insane("track "+n.label+" has already been added externally")}switch(n.kind){case f.Subtitle:e=n.id||"sub"+this.currentSubIdx,i=n.label||"Subtitles ("+this.currentSubIdx+")",this.currentSubIdx++;break;case f.ForcedSubtitle:e=n.id||"fsub"+this.currentSubIdx,i=n.label||"Subtitles ("+this.currentSubIdx+")) (Forced)",this.currentSubIdx++;break;case f.Caption:e=n.id||"CC"+this.currentCCIdx,i=n.label||"Captions (CC "+this.currentCCIdx+")",this.currentCCIdx++;break;default:return this.metadataTracks.push(n),n.mode=r.Hidden,void n.addEventListener("cuechange",this.onMetadataCueChangeHandler)}this.context.logger.debug("adding "+n.kind+" text track "+e),this.availableTracks[e]={id:e,url:null,kind:n.kind,lang:n.language||"unknown",label:i,textTrack:n,isFragmented:s,isExternal:!1,loadPromise:Promise.resolve()},i=this.getLabelForSubtitle(this.availableTracks[e]),i&&"string"==typeof i&&(this.availableTracks[e].label=i),this.recentlyAddedTracks.push(n),n.addEventListener("cuechange",this.onCueChange),n.kind!==f.ForcedSubtitle&&this.eventHandler.dispatchEvent(o.PlayerEvent.SubtitleAdded,{subtitle:this.availableTracks[e]}),n.mode=r.Disabled;var h=window.setTimeout(function(){a.recentlyAddedTracks=a.recentlyAddedTracks.filter(function(t){return t!==n}),Object.keys(a.availableTracks).map(function(t){return a.availableTracks[t]}).filter(function(t){return t.enabled&&Boolean(t.textTrack)&&t.textTrack.mode===r.Disabled}).forEach(function(t){a.showNative||a.showNativeAlways?t.textTrack.mode=r.Showing:t.textTrack.mode=r.Hidden})},0);this.timeoutsToClear.push(h),this.hasStoredAllTracks()&&this.setForcedSubtitles()},t.prototype.hasStoredAllTracks=function(){var t=Object.keys(this.availableTracks).length;return this.video.textTracks.length===t},t.prototype.getLabelForSubtitle=function(t){var e={kind:t.kind,lang:t.lang},i=this.getLabelingFunctionForSubtitle();return i(e)},t.prototype.getLabelingFunctionForSubtitle=function(){var t=this.context.sourceContext,e=t&&t.source&&t.source.labeling;return e&&e[this.type]&&e[this.type].subtitles?"function"!=typeof e[this.type].subtitles?this.getDefaultLabelForSubtitle:e[this.type].subtitles:this.getDefaultLabelForSubtitle},t.prototype.getIdFromTextTrack=function(t){var e;return(null===(e=Object.values(this.availableTracks).find(function(e){return e.textTrack===t}))||void 0===e?void 0:e.id)||null},t.prototype.getTextTrackAndSubtitleId=function(){for(var t=this.video.textTracks,e=0,i=t;e<i.length;e++){var a=i[e];if((a.mode===r.Showing||a.mode===r.Hidden)&&a.kind!==f.Metadata&&a.kind!==f.ForcedSubtitle)return[a,this.getIdFromTextTrack(a)]}return[void 0,void 0]},t.prototype.enableNative=function(){var t=this;Object.keys(this.availableTracks).map(function(e){return t.availableTracks[e]}).filter(function(t){return t.enabled&&Boolean(t.textTrack)}).forEach(function(t){return t.textTrack.mode=r.Showing}),this.showNative=!0},t.prototype.disableNative=function(){var t=this;Object.keys(this.availableTracks).map(function(e){return t.availableTracks[e]}).filter(function(t){return t.enabled&&Boolean(t.textTrack)}).forEach(function(t){return t.textTrack.mode=r.Hidden}),this.showNative=!1},t.prototype.seek=function(){var t=this;Object.keys(this.availableTracks).map(function(e){return t.availableTracks[e]}).filter(function(t){return t.enabled&&Boolean(t.textTrack)}).forEach(function(t){var e=t.textTrack.mode;t.textTrack.mode=r.Disabled,t.textTrack.mode=e})},t.prototype.getForcedSubtitleForSelectedLanguage=function(){var t,e,i,a=this.video.audioTracks;if(this.activeSubtitleId)i=null===(e=this.availableTracks[this.activeSubtitleId])||void 0===e?void 0:e.lang;else{if(!a)return;var r=Object.values(a).findIndex(function(t){var e=t.enabled;return e});i=null===(t=a[r])||void 0===t?void 0:t.language}return Object.values(this.availableTracks).filter(function(t){return t.kind===f.ForcedSubtitle}).find(function(t){return t.lang===i})},t.prototype.dispose=function(){var t;this.removeAll(),this.eventHandler=null,this.activeCues=null,this.availableTracks=null,this.metadataTracks=null,null===(t=this.video.audioTracks)||void 0===t?void 0:t.removeEventListener("change",this.audioChangeHandler),this.video&&this.video.textTracks&&"function"==typeof this.video.textTracks.addEventListener&&(this.video.textTracks.removeEventListener("addtrack",this.addTrack),this.video.textTracks.removeEventListener("change",this.textTracksChangeHandler)),this.subtitleLoader&&this.subtitleLoader.dispose(),this.subtitleLoader=null},t}();e.TextTrackController=g},504:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=i(0),r=i(255);e.NativeSubtitlesModuleDefinition={name:a.ModuleName.SubtitlesNative,module:function(){return{TextTrackController:r.TextTrackController}},dependencies:[a.ModuleName.Subtitles]},e["default"]=e.NativeSubtitlesModuleDefinition},505:function(t,e,i){"use strict";var a=this&&this.__assign||function(){return a=Object.assign||function(t){for(var e,i=1,a=arguments.length;i<a;i++){e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},a.apply(this,arguments)};Object.defineProperty(e,"__esModule",{value:!0}),e.CEA_608_MAX_LINE_LENGTH=32;var r=function(){function t(){}return t.cueListToArray=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i]);return e},t.sortEqualStartTimeByLineFn=function(t,e){if("line"in t&&"line"in e&&t.startTime===e.startTime){if(t.line<e.line)return-1;if(t.line>e.line)return 1}return 0},t.sortByStartTimeFn=function(t,e){return t.startTime<e.startTime?-1:t.startTime>e.startTime?1:0},t.sort=function(e){return e.sort(t.sortByStartTimeFn),e.sort(t.sortEqualStartTimeByLineFn),e},t.getTagIndexRanges=function(t){for(var e,i=RegExp("<[^>]*>","g"),a=[];e=i.exec(t);){var r=e[0];a.push({start:e.index,end:e.index+r.length-1})}return a},t.splitCea608Cue=function(i){for(var a=e.CEA_608_MAX_LINE_LENGTH-i.position.column,r=i.text,n=t.getTagIndexRanges(r),s=[],o=0,l=0,u=!1,d=0,c=0;c<r.length;){if(c===r.length-1){s.push(r.substring(o));break}n.length>0&&c===n[0].start&&(u=!0),u||(l++," "===r[c]&&(d=c),l===a&&(c=d+1,s.push(r.substring(o,c)),o=c,l=1)),u&&n.length>0&&c===n[0].end&&(u=!1,n.shift()),c++}var h=t.createCueEvents(s,i);return t.adjustCea608CaptionPositioning(h),h},t.createCueEvents=function(t,e){var i=t.length-1;return t.map(function(t){var r=a({},e);return r.text=t,r.position={column:r.position.column,row:r.position.row-i},i--,r})},t.adjustCea608CaptionPositioning=function(t){var e=14,i=Math.max.apply(Math,t.map(function(t){return t.position.row})),a=Math.min.apply(Math,t.map(function(t){return t.position.row}));if(i>e){var r=e-i;t.forEach(function(t){return t.position.row+=r})}if(a<0){var n=0-a;t.forEach(function(t){return t.position.row+=n})}},t}();e.TextTrackCueHelper=r}},[504])});
})();
